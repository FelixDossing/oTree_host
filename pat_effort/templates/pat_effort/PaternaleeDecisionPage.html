{% extends "global/Page.html" %}
{% load staticfiles otree %}

{% block title %}
Round {{ player.round_number }} out of {{ Constants.num_rounds }}
{% endblock %}


{% block content %}

<p id="scroll_info"><strong>Scroll up to change previous choice</strong></p>
<div id="instructions_div" class="instructions well well-1g">
  <h3>Instructions</h3>
  <p>
    {% if player.role == 'paternalee_first' %}
    {% if player.round_number == 1 %}In the following 4 rounds you will be able to earn real money through effort in the slider task.<br><br>{% endif %}
    Before entering the slider task, you will be asked to
    make a number of choices, which will influence whether the <span class="btn btn-primary">surf the web</span>-button will be removed from your slider task-screen in
    the following round. Having the button present on the screen may be seen as an advantage, since it allows one to substitute the task for something more
    interesting. On the other hand, not having the button present on the screen may be seen as an advantage, if one doesn't wish to have the posibility of deviating from the task.<br><br>
    The choices are named <strong>1A, 1B, 1C, 1D,
    2A, 2B, 2C, 2D</strong>. Each of these 8 choices will be implemented with an equal probability, which means that each choice has a 12.5% chance of having consequences for you. Some
    choices may involve a cost. This cost is only subtracted from your earnings if the choice is actually implemented.<br><br>
    {% endif %}


    You have been partnered with <strong>Player {{ player.partner_id }}</strong> in this round.<br><br>

    <strong>On this screen</strong> we ask you to make choices, which determine whether <strong>Player {{ player.partner_id }}</strong> will be given the choice of removing the
    <span class="btn btn-primary">surf the web</span>-button from <strong>your slider task-screen</strong> in the following round. This means that when you select the following probabilities, you are
    choosing the probability that Player {{ player.partner_id }} will be <em>allowed</em> to remove the button. Whether or not Player {{ player.partner_id }} chooses to remove the button from your screen
    if given this choice is completely up to her/him. If you choose a high percentage, it means that it
    is likely that Player {{ player.partner_id }} will be allowed to remove the button <strong>from your screen</strong> if he or she wishes. If you choose a low percentage, it means that it is unlikely
    that Player {{ player.partner_id }} will be allowed to remove the button <strong>from your screen</strong> if he or she wishes.
  </p>
</div>
<br>

<h2>Choice <strong>{% if player.role == 'paternalee_first' %}1{% else %}2{% endif %}A</strong></h2>
<p>Click below to determine the probability that your partner can remove the <span class="btn btn-primary">surf the web</span>-button from <strong>your screen</strong> if this choice
  (<strong>{% if player.role == 'paternalee_first' %}1{% else %}2{% endif %}A</strong>) is implemented.</p>
<div id="choice1_div">
{% formfield player.paternalee_decision1 label="Please choose a probability with which you wish your partner to be given this choice:" %}
</div>
<p>The probability that <strong>Player {{ player.partner_id }}</strong> will be allowed to remove the button is: <strong><span id="choice1_prob"></span></strong></p>
<br><button type="button" id="continue1">Continue</button>

<br><br><br><br>

<div id="choice2">
<h2>Choice <strong>{% if player.role == 'paternalee_first' %}1{% else %}2{% endif %}B</strong></h2>
<p>If this choice (<strong>{% if player.role == 'paternalee_first' %}1{% else %}2{% endif %}B</strong>) is implemented, you may choose to pay a cost in order to determine the probability with which your partner will be allowed to remove the <span class="btn btn-primary">surf the web</span>
  -button from <strong>your screen</strong>. This choice is similar to the previous choice except for the fact that it involves potential costs.
  The relation between your chosen percentage and the cost you pay (if this choice is implemented) is shown in the graph beneath (you can hover over the bar with the mouse to see the exact cost).</p>
<br>
<div id="choice2_div">
{% formfield player.paternalee_decision2 label="Please choose a probability with which you wish your partner to be given this choice:" %}
</div>
<p>The probability that <strong>Player {{ player.partner_id }}</strong> will be allowed to remove the button is: <strong><span id="choice2_prob"></span></strong></p>
<p>You will pay: <strong><span id="choice2_cost"></span></strong></p>
<br><button type="button" id="continue2">Continue</button>
</div>

<br><br><br><br>

<div id="choice3">
<h2>Choice <strong>{% if player.role == 'paternalee_first' %}1{% else %}2{% endif %}C</strong></h2>
<p>If this choice (<strong>{% if player.role == 'paternalee_first' %}1{% else %}2{% endif %}C</strong>) is implemented, you may choose to pay a cost in order to determine the probability with which your partner will be allowed to remove the <span class="btn btn-primary">surf the web</span>
  -button from <strong>your screen</strong>. This choice is similar to the previous choice except for the fact that the size of the potential costs has changed.
  The relation between your chosen percentage and the cost you pay (if this choice is implemented) is shown in the graph beneath (you can hover over the bar with the mouse to see the exact cost).</p>
<br>
<div id="choice3_div">
{% formfield player.paternalee_decision3 label="Please choose a probability with which you wish your partner to be given this choice:" %}
</div>
<p>The probability that <strong>Player {{ player.partner_id }}</strong> will be allowed to remove the button is: <strong><span id="choice3_prob"></span></strong></p>
<p>You will pay: <strong><span id="choice3_cost"></span></strong></p>
<br><button type="button" id="continue3">Continue</button>
</div>

<br><br><br><br>

<div id="choice4">
<h2>Choice <strong>{% if player.role == 'paternalee_first' %}1{% else %}2{% endif %}D</strong></h2>
<p>If this choice (<strong>{% if player.role == 'paternalee_first' %}1{% else %}2{% endif %}D</strong>) is implemented, you may choose to pay a cost in order to determine the probability with which your partner will be allowed to remove the <span class="btn btn-primary">surf the web</span>
  -button from <strong>your screen</strong>. This choice is similar to the previous choice except for the fact that the size of the potential costs has changed.
  The relation between your chosen percentage and the cost you pay (if this choice is implemented) is shown in the graph beneath (you can hover over the bar with the mouse to see the exact cost).</p>
<br>
<div id="choice4_div">
{% formfield player.paternalee_decision4 label="Please choose a probability with which you wish your partner to be given this choice:" %}
</div>
<p>The probability that <strong>Player {{ player.partner_id }}</strong> will be allowed to remove the button is: <strong><span id="choice4_prob"></span></strong></p>
<p>You will pay: <strong><span id="choice4_cost"></span></strong></p>
<br>
<p>Scroll up if you want to change the choices on this page. You will not be able to change the choices once you have pressed the next-button.<p>
</div>

{% next_button %}

{% block styles %}
  <style type="text/css">

  #scroll_info {
    position: fixed;
    top: 10px;
    text-align: center;
    width: 100%;
    left: 0%;
    opacity: 0;
  }

  #choice2, #choice3, #choice4, .otree-btn-next {
    display: none;
  }

  </style>
{% endblock %}

{% block script %}
  <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>

  <script type="text/javascript">


  var paternaleeChoices = {{ Constants.paternaleeChoices|json }}

  var data0 = paternaleeChoices.slice(0,9);
  var data1 = paternaleeChoices.slice(9,18);
  var data2 = paternaleeChoices.slice(18,27);
  var data3 = paternaleeChoices.slice(27,36);

  maxCost_points = 40;
  number_of_choices = 4;

  // for (j=1; i<=4; i++) {
  //   $(".field-paternalee_decision"+j).click(function() {
  //     for (i=0; i<10; i++) {
  //       if($('#id_paternalee_decision'+j+'_'+i)is.(':checked')) {
  //         $('#choice1_prob').text(i*10+'%');
  //         $('#choice1_cost').text(data)
  //       }
  //     }
  //   })
  // }

  $(".field-paternalee_decision1").click(function() {
    for (i=1; i<10; i++) {
      if($('#id_paternalee_decision1_'+i).is(':checked')) {
        $('#choice1_prob').text(i*10+'%');
        $('#choice1_cost').text(data0[i-1].cost+' points');
      }
    }
  });
  $(".field-paternalee_decision2").click(function() {
    for (i=1; i<10; i++) {
      if($('#id_paternalee_decision2_'+i).is(':checked')) {
        $('#choice2_prob').text(i*10+'%');
        $('#choice2_cost').text(data1[i-1].cost+' points');
      }
    }
  });
  $(".field-paternalee_decision3").click(function() {
    for (i=1; i<10; i++) {
      if($('#id_paternalee_decision3_'+i).is(':checked')) {
        $('#choice3_prob').text(i*10+'%');
        $('#choice3_cost').text(data2[i-1].cost+' points');
      }
    }
  });
  $(".field-paternalee_decision4").click(function() {
    for (i=1; i<10; i++) {
      if($('#id_paternalee_decision4_'+i).is(':checked')) {
        $('#choice4_prob').text(i*10+'%');
        $('#choice4_cost').text(data3[i-1].cost+' points');
      }
    }
  });

  // Buttons
  $("#continue1").click(function() {
    oneChecked = false;
    for (i=1; i<10; i++) {
      if ($('#id_paternalee_decision1_'+i).is(':checked')) {
        oneChecked = true;
      }
    }
    if (oneChecked) {
      $('#choice2').show();
      $('html, body').animate({
        scrollTop: $('#choice2').offset().top - 10
      }, function() {
        $('#scroll_info').animate({opacity: '1', top:'5px'},300).stop().delay(1000).animate({opacity: '0', top: '10px'});
      })
    }
  })
  $("#continue2").click(function() {
    oneChecked = false;
    for (i=1; i<10; i++) {
      if ($('#id_paternalee_decision2_'+i).is(':checked')) {
        oneChecked = true;
      }
    }
    if (oneChecked) {
      $('#choice3').show();
      $('html, body').animate({
        scrollTop: $('#choice3').offset().top - 10
      }, function() {
        $('#scroll_info').animate({opacity: '1', top:'5px'},300).stop().delay(1000).animate({opacity: '0', top: '10px'});
      })
    }
  })
  $("#continue3").click(function() {
    oneChecked = false;
    for (i=1; i<10; i++) {
      if ($('#id_paternalee_decision3_'+i).is(':checked')) {
        oneChecked = true;
      }
    }
    if (oneChecked) {
      $('#choice4').show();
      $('html, body').animate({
        scrollTop: $('#choice4').offset().top - 10
      }, function() {
        $('#scroll_info').animate({opacity: '1', top:'5px'},300).stop().delay(1000).animate({opacity: '0', top: '10px'});
      });
      $('.otree-btn-next').show();
    }
  })



  function drawGraph(data, parrent) {

    var pcts = data.map(function(d) { return d.pct});

    var margin = {top: 5, right: 5, bottom: 50, left: 50};

    var fullWidth = 500;
    var fullHeight = 350;

    var width = fullWidth - margin.right - margin.left;
    var height = fullHeight - margin.top - margin.bottom;

    var svg = d3.select(parrent)
                .insert('svg',":first-child")
                .attr('width', fullWidth)
                .attr('height', fullHeight)
                // Bar chart drawn
                .append('g')
                //leave room for margins
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    var pctScale = d3.scaleBand()
    .domain(pcts)
    .range([0, width])
    .paddingInner(0.1);

    var bandwidth = pctScale.bandwidth();

    var maxCost = maxCost_points;
    var costScale = d3.scaleLinear()
    .domain([0, maxCost])
    .range([height, 0])
    .nice();

    var xAxis = d3.axisBottom(pctScale);
    var yAxis = d3.axisLeft(costScale);

    var xAxisEle = svg.append('g')
    .classed('x axis', true)
    .attr('transform', 'translate(0,' + height + ')')
    .call(xAxis);

    var yAxisEle = svg.append('g')
    .classed('y axis', true)
    .call(yAxis);


    // Label to yAxis
    var yText = yAxisEle.append('text')
    .attr('transform', 'rotate(-90)translate(-' + height/2 + ',0)')
    .style('text-anchor', 'middle')
    .style('fill', 'black')
    .attr('dy', '-2.5em')
    .text('COST IN POINTS');


    var barHolder = svg.append('g')
    .classed('bar-holder', true);

    var bars = barHolder.selectAll('rect.bar')
    .data(data)
    .enter()
    .append('rect')
    .classed('bar', true)
    .attr('x', function(d, i) {
      return pctScale(d.pct);
    })
    .attr('width', bandwidth)
    .attr('y', function(d) {
      return costScale(d.cost);
    })
    .attr('height', function(d) {
      return height - costScale(d.cost);
    })
    .attr('fill', 'teal')
    .on("mouseover", function(d) {
      d3.select(this)
      .attr("fill", "orange");

      var xPosition = parseFloat(d3.select(this).attr('x')) + bandwidth / 2;
      var yPosition = parseFloat(d3.select(this).attr('y')) + 15;
      svg.append('text')
        .attr('id', 'tooltip')
        .attr('x', xPosition)
        .attr('y', yPosition)
        .attr('text-anchor', 'middle')
        .attr('font-family', 'sans-serif')
        .attr('font-size', '13px')
        .attr('font-weight', 'bold')
        .attr('fill', 'black')
        .text(d.cost);

    })
    .on("mouseout", function() {
      d3.select(this)
      .attr("fill", "teal")
      d3.select('#tooltip').remove();
    })

  }

  drawGraph(data1, '#choice2_div');
  drawGraph(data2, '#choice3_div');
  drawGraph(data3, '#choice4_div');
  </script>

{% endblock %}

{% endblock %}
